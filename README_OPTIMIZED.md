# Оптимизация проекта — отчёт

Дата: 2025-08-15 05:30

Что сделано прямо сейчас:
- Сгенерирован `.env.example` на основе `app/config.py` — удобно для развёртывания и команды.
- Добавлен `.dockerignore` — уменьшает размер контекста сборки и ускоряет деплой.
- Добавлен `Dockerfile.optimized` — компактный образ, кэширование зависимостей, healthcheck.
- Дополнен `pyproject.toml` секциями `ruff` и `mypy` — единые правила стиля и типизации.
- Добавлен `Makefile` с частыми командами (`run`, `dev`, `fmt`, `lint`, `type`, `check`, `docker-build`).

Рекомендации (следующие шаги):
1) **Async & производительность**
   - Включить `uvloop` на Linux: `pip install uvloop` и `uvicorn ... --loop uvloop` (или через env).
   - Для FAISS нормализовать эмбеддинги (L2) и рассмотреть `IndexHNSWFlat`/`IVF` при росте корпуса.
   - Ограничить размеры загружаемых файлов (например, 20–50 МБ) и число страниц OCR через `OCR_MAX_PAGES`.

2) **Надёжность и безопасность**
   - Добавить проверки Content-Type и магических байт (сейчас проверяется только суффикс).
   - Лимитировать частоту запросов (rate limit) и защищать бот от флуд-атак.
   - Не логировать секреты и полные тексты документов; логировать только метаданные/хэши.

3) **Наблюдаемость**
   - Включить структурированные логи (JSON) и корреляционные ID запросов.
   - Пробросить метрики через `/metrics` (Prometheus) и считать: RPS, ошибки, OCR-время, FAISS-время.

4) **Качество кода**
   - Подключить `pre-commit` (ruff/mypy) и CI (GitHub Actions) для проверок при PR.

5) **Докер/Деплой**
   - На Render использовать переменную `PORT` (уже в CMD), webhook-режим для Telegram в проде.
   - Хранить индекс и тексты на persistent volume (`/data`) и монтировать его в сервис.

6) **UX**
   - Ответы бота сопровождайте источниками (название файла/страницы) и score из FAISS.
   - Добавьте команду `/status` и `/reindex` для админов.

См. также: `render.yaml` — можно обновить, чтобы ссылаться на `Dockerfile.optimized` и монтировать volume.
